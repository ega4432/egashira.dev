name: import

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 */3 * * *"

jobs:
  import:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - name: Generate token
        id: generate_token
        uses: tibdex/github-app-token@v1
        with:
          app_id: ${{ secrets.MY_APP_ID }}
          private_key: ${{ secrets.MY_APP_PRIVATE_KEY }}

      - name: Checkout source
        uses: actions/checkout@v3
        with:
          token: ${{ steps.generate_token.outputs.token }}

      - uses: ega4432/notion-to-markdown-action@v0
        id: import
        with:
          output_path: ./src/content/blog
          filename_property: slug
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}

      - name: Remove draft files and images
        if: steps.import.outputs.files_count > 0
        run: |
          draft_files=$(find src/content/blog -name '*.md' -exec grep -l "draft: true" {} \;)

          for target in $draft_files; do
            echo "target: $target"
            rm "$target"

            file_path="${target%.*}"

            if [ -d "$file_path" ]; then
              rm -rf "$file_path"
            fi
          done

      - name: Remove slug from frontmatter
        if: steps.import.outputs.files_count > 0
        run: find src/content/blog -name '*.md' -exec sed -i '/^slug:/d' {} \;

      - name: Move images to public directory
        if: steps.import.outputs.files_count > 0
        run: find ./src/content/blog -mindepth 1 -maxdepth 1 -type d -not -name "book-review" -exec sh -c 'mv {} ./public/images/blog/"$(basename {})"/' \;

      - name: Commit & push
        if: steps.import.outputs.files_count > 0
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add -N .
          git commit -a -m '[bot] Automatically import contents from Notion'
          git push
